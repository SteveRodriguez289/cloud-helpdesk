<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Cloud Helpdesk</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    input, button, textarea { padding: 8px; margin: 6px 0; width: 360px; }
    textarea { height: 90px; }
    .row { margin-bottom: 16px; }
    .ticket { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 6px; }
    .small { color: #666; font-size: 12px; }
    .error { color: #b00020; }
    .ok { color: #0a7; }
  </style>
</head>
<body>
  <h1>Cloud Helpdesk</h1>

  <div class="row">
    <h3>API Key</h3>
    <input id="apiKey" placeholder="Enter API Key" />
    <div>
      <button onclick="saveKey()">Save Key</button>
      <button onclick="clearKey()">Logout / Clear Key</button>
    </div>
    <div id="keyStatus" class="small"></div>
  </div>

  <div class="row">
    <h3>Create Ticket</h3>
    <input id="title" placeholder="Title" />
    <textarea id="description" placeholder="Description"></textarea>
    <div>
      <button onclick="createTicket()">Create</button>
    </div>
    <div id="createStatus" class="small"></div>
  </div>

  <div class="row">
    <h3>Tickets</h3>
    <button onclick="loadTickets()">Refresh Tickets</button>
    <div id="tickets"></div>
    <div id="loadStatus" class="small"></div>
  </div>

<script>
  function getKey() {
    return localStorage.getItem("API_KEY") || "";
  }

  function setKey(k) {
    localStorage.setItem("API_KEY", k);
  }

  function deleteKey() {
    localStorage.removeItem("API_KEY");
  }

  function headersWithKey() {
    const k = getKey();
    return {
      "Content-Type": "application/json",
      "X-API-KEY": k
    };
  }

  function saveKey() {
    const k = document.getElementById("apiKey").value.trim();
    if (!k) {
      document.getElementById("keyStatus").innerHTML = "<span class='error'>Key cannot be blank.</span>";
      return;
    }
    setKey(k);
    document.getElementById("keyStatus").innerHTML = "<span class='ok'>Saved.</span>";
  }

  function clearKey() {
    deleteKey();
    document.getElementById("apiKey").value = "";
    document.getElementById("keyStatus").innerHTML = "<span class='ok'>Cleared.</span>";
  }

  async function loadTickets() {
    document.getElementById("loadStatus").textContent = "Loading...";
    try {
      const res = await fetch("/tickets", { method: "GET", headers: headersWithKey() });
      const data = await res.json();

      if (!res.ok) {
        document.getElementById("tickets").innerHTML = "";
        document.getElementById("loadStatus").innerHTML = "<span class='error'>" + (data.error || "Error") + "</span>";
        return;
      }

      const container = document.getElementById("tickets");
      container.innerHTML = "";

      data.forEach(t => {
        const div = document.createElement("div");
        div.className = "ticket";
        div.innerHTML =
          "<b>#" + t.id + " â€” " + t.title + "</b><br/>" +
          "<div>" + t.description + "</div>" +
          "<div class='small'>Status: " + t.status + " | Created: " + t.created_at + "</div>";
        container.appendChild(div);
      });

      document.getElementById("loadStatus").innerHTML = "<span class='ok'>Loaded " + data.length + " ticket(s).</span>";
    } catch (e) {
      document.getElementById("loadStatus").innerHTML = "<span class='error'>Failed to load.</span>";
    }
  }

  async function createTicket() {
    document.getElementById("createStatus").textContent = "Sending...";
    const title = document.getElementById("title").value.trim();
    const description = document.getElementById("description").value.trim();

    try {
      const res = await fetch("/tickets", {
        method: "POST",
        headers: headersWithKey(),
        body: JSON.stringify({ title, description })
      });

      const data = await res.json();

      if (!res.ok) {
        document.getElementById("createStatus").innerHTML = "<span class='error'>" + (data.error || "Error") + "</span>";
        return;
      }

      document.getElementById("createStatus").innerHTML = "<span class='ok'>Ticket created.</span>";
      document.getElementById("title").value = "";
      document.getElementById("description").value = "";
      loadTickets();
    } catch (e) {
      document.getElementById("createStatus").innerHTML = "<span class='error'>Request failed.</span>";
    }
  }

  // On page load: fill key box from storage + load tickets
  (function init() {
    const k = getKey();
    document.getElementById("apiKey").value = k;
    document.getElementById("keyStatus").textContent = k ? "Key loaded from browser storage." : "No key saved yet.";
    // only auto-load if key exists
    if (k) loadTickets();
  })();
</script>
</body>
</html>

